#!/usr/bin/env ruby
# frozen_string_literal: true

require 'test/unit'
require 'colorize'
require_relative 'test_module'
require 'korekto/refinements'
require 'korekto/syntax'
# Mockups
module Korekto
  class Error < RuntimeError; end

  class Syntax
    def test_syntax = @syntax
    def test_validate_bang(...) = validate!(...)
  end
end

class TestSyntax < Test::Unit::TestCase
  include TestModule

  def setup
    @syntax = Korekto::Syntax.new
  end

  def test_coverage = coverage Korekto::Syntax

  def test_initialize
    assert_equal [], @syntax.test_syntax
  end

  # rubocop: disable Metrics
  def test_push
    @syntax.push 'length < 120'
    assert_equal ['length < 120'], @syntax.test_syntax
    @syntax.push "ltight?('!')"
    assert_equal ['length < 120', "ltight?('!')"], @syntax.test_syntax
    # Near duplicate test in test_validate_bang:
    error = assert_raises(Korekto::Error) do
      @syntax.push 'leNgTh < 120'
    end
    assert_equal 'NameError: leNgTh < 120', error.message
  end

  def test_validate_bang
    error = assert_raises(Korekto::Error) do
      @syntax.test_validate_bang 'length'
    end
    assert_equal 'syntax must eval boolean', error.message
    # Near duplicate test in test_push:
    assert_raises(NameError) do
      @syntax.test_validate_bang 'leNgTh < 120'
    end
    @syntax.push 'length < 120'
    error = assert_raises(Korekto::Error) do
      @syntax.test_validate_bang 'length < 120'
    end
    assert_equal 'duplicate syntax', error.message
  end

  def test_check_bang
    @syntax.push "ltight?('!')"
    assert_nothing_raised do
      @syntax.check!('2! = 4')
    end
    error = assert_raises(Korekto::Error) do
      @syntax.check!('2 ! = 4')
    end
    assert_equal "syntax: ltight?('!')", error.message
  end
  # rubocop: enable Metrics
end
