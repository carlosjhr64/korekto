#!/usr/bin/env ruby
# frozen_string_literal: true

require 'korekto'

HELP = <<~HELP.freeze
  # Korekto
  Usage:
    korekto [:options+]
    korekto <filename>
  Options:
    -h --help
    -v --version
    -s --syntax \tAllow syntax eval on STDIN
    --scrape    \tScrape Korekto lines
    --trace     \tShow trace of each line, not just edits and errors
    --install   \tInstalls the korekto neovim ruby plugin
    --readme    \tOpen Korekto's README.md
    --heap=SIZE \tSet heap size (default: #{Korekto.heap})
    --warn      \tShow warnings
  Types:
    SIZE    /^\\d+$/
  Exclusive:
    scrape trace install readme
  ## Example usage
  * Read/Edit
      korekto MARKDOWN.md
  * Check/Verify
      korekto < MARKDOWN.md
      cat MARKDOWN.md | korekto
HELP

def nvim_config_get
  dir = ENV['XDG_CONFIG_HOME'] || File.expand_path('~/.config')
  "#{dir}/nvim"
end

def nvim_config!
  unless File.directory?(nvim_config = nvim_config_get)
    warn 'Could not get nvim config directory'
    exit 78 # EX_CONFIG
  end
  nvim_config
end

def dir_join(name) = File.join(File.dirname(__dir__), name)

def do_install!
  nvim_config = nvim_config!
  korekto_config = dir_join('config')
  require 'fileutils'
  FileUtils.cp_r("#{korekto_config}/.", nvim_config)
  system "nvim -c ':UpdateRemotePlugins|:quit'"
  exit 0 # EX_OK
end

def exec_neovim!(filename)
  unless File.exist?(filename)
    warn "File does not exist: #{filename}"
    exit 66 # EX_NOINPUT
  end

  nvim_config = nvim_config!
  exec "nvim -u #{nvim_config}/korekto.lua #{filename}"
end

def exec_readme! = exec_neovim!(dir_join('README.md'))

def do_exitable!(options)
  exec_neovim!(options.filename) if options.filename?
  do_install! if options.install?
  exec_readme! if options.readme?
end

def handle_options
  require 'help_parser'
  options = HelpParser[Korekto::VERSION, HELP]
  do_exitable!(options)
  Korekto.syntax = options.syntax?
  Korekto.scrape = options.scrape?
  Korekto.trace  = options.trace?
  Korekto.warn   = options.warn?
  Korekto.heap   = options.heap.to_i if options.heap?
end

handle_options unless ARGV.empty?
Korekto.run
